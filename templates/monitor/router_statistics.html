{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Router Statistics - {{ router_id }}</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="body_router_details">
    <h1 class="blue-background">Router Statistics - {{ router_id }}</h1><br>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a href="/monitor/monitor" class="col-xs-4 navbar-brand">Logo</a>
        <ul class=" col-xs-4 navbar-nav mx-auto">
          <li class="nav-item"><a href="/monitor/bgp-stats" class="nav-link">BGP Statistics</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Link 2</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Link 3</a></li>
          <li class="nav-item"><a href="#" class="nav-link">Link 4</a></li>
        </ul>
      </nav>
    <br><br>
    <table border="1" id="routerDetailsTable">
        <thead>
            <tr>
                <th>IP</th>
                <th>Hostname</th>
                <th>IOS</th>
                <th>Memory</th>
                <th>Model</th>
                <th>Serial Number</th>
                <th>Uptime</th>
                <th>version</th>
            </tr>
        </thead>
        <tbody>
           
        </tbody>
    </table>
    <br><br>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h3>CPU Load</h3>
                <canvas id="cpuLoadChart"></canvas>
            </div>
            <div class="col-md-6">
                <h3>Memory Usage</h3>
                <canvas id="memoryUsageChart"></canvas>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <label for="start_time">Start Time:</label>
                <input type="datetime-local" id="start_time" name="start_time">
            </div>
            <div class="col-md-6">
                <label for="end_time">End Time:</label>
                <input type="datetime-local" id="end_time" name="end_time">
            </div>
        </div>
        <button id="updateChartButton">Update Charts</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        $(document).ready(function() {
            var router_id = window.location.pathname.split('/').filter(Boolean).pop();

            $.ajax({
                url: '/monitor/router_details/' + router_id + '/',
                type: 'GET',
                success: function(data) {
                    var tableBody = $('#routerDetailsTable tbody');
                    var row = $('<tr>');
                    row.append($('<td>').text(data.ip));
                    row.append($('<td>').text(data.hostname));
                    row.append($('<td>').text(data.ios));
                    row.append($('<td>').text(data.memory));
                    row.append($('<td>').text(data.model));
                    row.append($('<td>').text(data.serial));
                    row.append($('<td>').text(data.uptime));
                    row.append($('<td>').text(data.version));
                    tableBody.append(row);
                },
                error: function(error) {
                    console.error('Error retrieving router details:', error);
                }
            });

            function fetchStats(start_time, end_time) {
                var url = '/monitor/router_cpu_mem/' + router_id + '/';
                if (start_time && end_time) {
                    url += '?start_time=' + encodeURIComponent(start_time) + '&end_time=' + encodeURIComponent(end_time);
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(data) {
                        console.log('Data received:', data.cpu); // Verifică dacă datele sunt primite corect
                        updateCharts(data.timestamps, data.cpu, data.memory);
                    },
                    error: function(error) {
                        console.error('Error retrieving router stats:', error);
                    }
                });
            }

            var ctxCpu = document.getElementById('cpuLoadChart').getContext('2d');
            var ctxMemory = document.getElementById('memoryUsageChart').getContext('2d');

            var cpuLoadChart = new Chart(ctxCpu, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Load',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute'
                            }
                        },
                        y: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            var memoryUsageChart = new Chart(ctxMemory, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory Usage',
                        data: [],
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute'
                            }
                        },
                        y: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            function updateCharts(timestamps, cpuData, memoryData) {
                cpuLoadChart.data.labels = timestamps;
                cpuLoadChart.data.datasets[0].data = cpuData;
                cpuLoadChart.update();

                memoryUsageChart.data.labels = timestamps;
                memoryUsageChart.data.datasets[0].data = memoryData;
                memoryUsageChart.update();
            }

            $('#updateChartButton').click(function() {
                console.log('Update button clicked');
                var start_time = $('#start_time').val();
                var end_time = $('#end_time').val();
                fetchStats(start_time, end_time);
            });

            fetchStats();
            setInterval(function() {
                var start_time = $('#start_time').val();
                var end_time = $('#end_time').val();
                fetchStats(start_time, end_time);
            }, 30000);  // Actualizează la fiecare 30 de secunde
        });
    </script>
</body>
</html>
